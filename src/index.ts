/**
 * @file Virtual 8-Bit Computer
 * @copyright Alexander Bass 2025
 * @license GPL-3.0
 */
import Computer from "./computer";
import UI from "./ui";
import { $ } from "./etc";
import { ISA } from "./instructionSet";
import { generateIsaTable } from "./isaGenerator";
import { u8 } from "./num";

import "./style/style.scss";
import { CpuEvent } from "./events";

declare global {
	interface Window {
		comp: Computer;
		ui: UI;
		firehose: () => void;
	}
}

function main(): void {
	// prettier-ignore
	const program: Array<u8> = [0x21, 0x22, 0x19, 0x06, 0x38, 0xFF, 0x06, 0x01, 0x19, 0x06, 0x49, 0xFF, 0x06, 0x01, 0x19, 0x06, 0x57, 0xFF, 0x06, 0x01, 0x19, 0x06, 0x58, 0xFF, 0x06, 0x01, 0x19, 0x06, 0x59, 0xFF, 0x06, 0x01, 0x21, 0x87, 0xF0, 0x00, 0x43, 0x00, 0x01, 0xFE, 0x60, 0x33, 0x07, 0x06, 0xFF, 0x5E, 0x06, 0x23, 0x07, 0x22, 0x21, 0x87, 0x17, 0x07, 0x53, 0x06, 0x11, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x5E, 0x06, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x5E, 0x06, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x51, 0x06, 0x0E, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x51, 0x06, 0x02, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x51, 0x06, 0x0E, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x5E, 0x06, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x5E, 0x06, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x53, 0x06, 0x11, 0x21, 0x8B, 0x17, 0x06, 0x21, 0x34, 0x13, 0x71, 0x17, 0x07, 0xFD, 0x60, 0x43, 0x00, 0x01, 0x50, 0x70, 0x17, 0x04, 0x23, 0x07, 0xA1, 0x31, 0x04, 0x01, 0x03, 0x21, 0xA9, 0x19, 0x04, 0x0C, 0x48, 0x41, 0x43, 0x04, 0x01, 0xFD, 0x60, 0x47, 0x04, 0x01, 0x40, 0x04, 0xFE, 0x60, 0x33, 0x07, 0x06, 0xFF, 0x5E, 0x06, 0x23, 0x07, 0x89, 0x17, 0x06, 0xFD, 0x67, 0x49, 0x07, 0x01, 0xFE, 0x67, 0x33, 0x07, 0x06, 0xFF, 0x5E, 0x06, 0x23, 0x07, 0xBD, 0x21, 0x87, ];
	while (program.length < 256) {
		program.push(0x00);
	}
	const computer = new Computer();

	const ui = new UI();
	ui.initEvents(computer.events);
	computer.loadMemory(program);
	computer.initEvents(ui.cpu_signaler);
	window.comp = computer;
	window.ui = ui;

	$("ISA").replaceWith(generateIsaTable(ISA));

	// to log all cpu events, run `firehose()` in console
	let fire = false;
	window.firehose = (): void => {
		if (fire === false) {
			computer.events.firehose((ident, data) => {
				console.log(`New Event: ${CpuEvent[ident]}. data: `, data);
			});
			fire = true;
		} else {
			console.error("Firehose already started");
		}
	};
}

document.addEventListener("DOMContentLoaded", () => {
	main();
});
